name: Check Config Attachment

on:
  issues:
    types: [opened, edited, reopened]

jobs:
  check-config-attachment:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      # –®–ê–ì 1: –ü–æ–∏—Å–∫ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–ª–æ–∂–µ–Ω–∏–µ –≤ —Ç–µ–ª–µ issue
      - name: Check attachment status
        id: check_attachment
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const issue = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber
            });

            let attachmentFound = false;
            let fileAccessible = false;
            let fileUrl = '';

            const markdownRegex = /\[config\.tar\.gz\]\((https?:\/\/[^\s)]+)\)/i;
            const match = issue.data.body.match(markdownRegex);

            if (match && match[1]) {
              attachmentFound = true;
              fileUrl = match[1];
              try {
                const response = await fetch(fileUrl, { method: 'HEAD' });
                if (response.ok) {
                  fileAccessible = true;
                }
              } catch (error) {
                fileAccessible = false;
              }
            }

            core.setOutput('attachment_found', attachmentFound.toString());
            core.setOutput('file_accessible', fileAccessible.toString());
            core.setOutput('file_url', fileUrl);

      # –®–ê–ì 2: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ, —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏–≤–∞ (–≤–∫–ª—é—á–∞—è –≤–µ—Ä—Å–∏—é)
      - name: Extract and verify archive contents
        id: verify_archive
        if: steps.check_attachment.outputs.attachment_found == 'true' && steps.check_attachment.outputs.file_accessible == 'true'
        env:
          FILE_URL: ${{ steps.check_attachment.outputs.file_url }}
        run: |
          set -e
          echo "Downloading config.tar.gz from $FILE_URL..."
          curl -L -s -o "/tmp/config.tar.gz" "$FILE_URL"

          if [ ! -s "/tmp/config.tar.gz" ]; then
            echo "ERROR: Downloaded file is empty or does not exist."
            echo "file_valid=false" >> $GITHUB_OUTPUT
            echo "verification_error=Archive is empty or failed to download." >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Extracting archive to verify contents..."
          EXTRACT_DIR=$(mktemp -d)
          cd "$EXTRACT_DIR"

          if ! tar -xzf /tmp/config.tar.gz 2>/dev/null; then
            echo "ERROR: Failed to extract config.tar.gz."
            echo "file_valid=false" >> $GITHUB_OUTPUT
            echo "verification_error=Failed to extract archive. File may be corrupted." >> $GITHUB_OUTPUT
            exit 0
          fi

          # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ console.log
          REQUIRED_FILE="opt/config/mod_data/log/console.log"
          if [ ! -f "$EXTRACT_DIR/$REQUIRED_FILE" ]; then
            echo "ERROR: Required file '$REQUIRED_FILE' NOT found."
            echo "file_valid=false" >> $GITHUB_OUTPUT
            echo "verification_error=The archive does not contain the required file: $REQUIRED_FILE" >> $GITHUB_OUTPUT
            rm -rf "$EXTRACT_DIR"
            rm -f "/tmp/config.tar.gz"
            exit 0
          fi
          echo "SUCCESS: Required file '$REQUIRED_FILE' found."

          # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –º–æ–¥–∞ (—Å–Ω–∞—á–∞–ª–∞ 5X, –ø–æ—Ç–æ–º 5M)
          VERSION_CHECK_MESSAGE=""
          VERSION_OUTDATED="false"

          VERSION_FILE_5X="opt/config/mod/version_5x.txt"
          REMOTE_VERSION_URL_5X="https://raw.githubusercontent.com/ghzserg/zmod_ff5x/refs/heads/1.6/version_5x.txt"

          if [ -f "$EXTRACT_DIR/$VERSION_FILE_5X" ]; then
            echo "Found $VERSION_FILE_5X, checking version..."
            LOCAL_VERSION_5X=$(cat "$EXTRACT_DIR/$VERSION_FILE_5X" | xargs)
            REMOTE_VERSION_5X=$(curl -s -f "$REMOTE_VERSION_URL_5X" | xargs)

            if [ -z "$REMOTE_VERSION_5X" ]; then
              echo "WARNING: Could not fetch remote version from $REMOTE_VERSION_URL_5X"
              VERSION_CHECK_MESSAGE="‚ö†Ô∏è Could not check for updates (failed to fetch latest version)."
            elif [ "$LOCAL_VERSION_5X" != "$REMOTE_VERSION_5X" ]; then
              echo "OUTDATED: Local version ($LOCAL_VERSION_5X) differs from remote ($REMOTE_VERSION_5X)."
              VERSION_OUTDATED="true"
              VERSION_CHECK_MESSAGE="Your mod version **$LOCAL_VERSION_5X** does not match the latest version **$REMOTE_VERSION_5X**."
            else
              echo "UP-TO-DATE: Version $LOCAL_VERSION_5X is current."
              VERSION_CHECK_MESSAGE="Your mod version **$LOCAL_VERSION_5X** is up to date."
            fi

          else
            VERSION_FILE_5M="opt/config/mod/version_5m.txt"
            REMOTE_VERSION_URL_5M="https://raw.githubusercontent.com/ghzserg/zmod_ff5m/refs/heads/1.6/version_5m.txt"

            if [ -f "$EXTRACT_DIR/$VERSION_FILE_5M" ]; then
              echo "Found $VERSION_FILE_5M, checking version..."
              LOCAL_VERSION_5M=$(cat "$EXTRACT_DIR/$VERSION_FILE_5M" | xargs)
              REMOTE_VERSION_5M=$(curl -s -f "$REMOTE_VERSION_URL_5M" | xargs)

              if [ -z "$REMOTE_VERSION_5M" ]; then
                echo "WARNING: Could not fetch remote version from $REMOTE_VERSION_URL_5M"
                VERSION_CHECK_MESSAGE="‚ö†Ô∏è Could not check for updates (failed to fetch latest version)."
              elif [ "$LOCAL_VERSION_5M" != "$REMOTE_VERSION_5M" ]; then
                echo "OUTDATED: Local version ($LOCAL_VERSION_5M) differs from remote ($REMOTE_VERSION_5M)."
                VERSION_OUTDATED="true"
                VERSION_CHECK_MESSAGE="Your mod version **$LOCAL_VERSION_5M** does not match the latest version **$REMOTE_VERSION_5M**."
              else
                echo "UP-TO-DATE: Version $LOCAL_VERSION_5M is current."
                VERSION_CHECK_MESSAGE="Your mod version **$LOCAL_VERSION_5M** is up to date."
              fi

            else
              echo "ERROR: No version file found (neither 5x.txt nor 5m.txt)."
              echo "file_valid=false" >> $GITHUB_OUTPUT
              echo "verification_error=The archive does not contain a valid version file (version_5x.txt or version_5m.txt)." >> $GITHUB_OUTPUT
              rm -rf "$EXTRACT_DIR"
              rm -f "/tmp/config.tar.gz"
              exit 0
            fi
          fi

          echo "file_valid=true" >> $GITHUB_OUTPUT
          echo "verification_error=" >> $GITHUB_OUTPUT
          echo "version_outdated=$VERSION_OUTDATED" >> $GITHUB_OUTPUT
          echo "version_check_message=$VERSION_CHECK_MESSAGE" >> $GITHUB_OUTPUT

          rm -rf "$EXTRACT_DIR"
          rm -f "/tmp/config.tar.gz"

      # –®–ê–ì 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –£–°–ü–ï–®–ù–û–ì–û —Å—Ü–µ–Ω–∞—Ä–∏—è (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–µ—Ä—Å–∏–∏)
      - name: Handle successful and valid attachment
        if: steps.check_attachment.outputs.attachment_found == 'true' && steps.check_attachment.outputs.file_accessible == 'true' && steps.verify_archive.outputs.file_valid == 'true'
        uses: actions/github-script@v6
        env:
          VERSION_OUTDATED: ${{ steps.verify_archive.outputs.version_outdated }}
          VERSION_CHECK_MESSAGE: ${{ steps.verify_archive.outputs.version_check_message }}
        with:
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const issue = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber
            });

            const versionOutdated = process.env.VERSION_OUTDATED === 'true';
            const versionMessage = process.env.VERSION_CHECK_MESSAGE || '';

            // --- –°–¶–ï–ù–ê–†–ò–ô 1: –í–ï–†–°–ò–Ø –£–°–¢–ê–†–ï–õ–ê ---
            if (versionOutdated) {
              // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ —Ç–∏–∫–µ—Ç –ó–ê–ö–†–´–¢
              if (issue.data.state === 'open') {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  state: 'closed'
                });
              }

              let commentBody = '‚úÖ **Archive Check Passed** / **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏–≤–∞ –ø—Ä–æ–π–¥–µ–Ω–∞**\n';
              commentBody += `The file \`config.tar.gz\` is valid. / –§–∞–π–ª \`config.tar.gz\` –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.\n\n`;

              commentBody += `üî¥ **Action Required / –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏–µ:** ${versionMessage}\n\n`;

              commentBody += 'üö´ **Issue Status / –°—Ç–∞—Ç—É—Å —Ç–∏–∫–µ—Ç–∞:**\n';
              commentBody += 'This issue will remain **closed** until the mod is updated to the latest version.\n';
              commentBody += '–¢–∏–∫–µ—Ç –æ—Å—Ç–∞–Ω–µ—Ç—Å—è **–∑–∞–∫—Ä—ã—Ç—ã–º** –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–¥–∞ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏.\n\n';

              commentBody += 'üîÑ **Please update your mod first! / –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–∏—Ç–µ –º–æ–¥!**\n';
              commentBody += '- Update guide (English): https://github.com/ghzserg/zmod/wiki/Setup_en#updating-the-mod\n';
              commentBody += '- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é (–†—É—Å—Å–∫–∏–π): https://github.com/ghzserg/zmod/wiki/Setup#%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BC%D0%BE%D0%B4%D0%B0\n\n';

              commentBody += 'After updating, please **edit this issue** (no need to create a new one). The check will run again and reopen it if the version matches.\n';
              commentBody += '–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è **–æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ç–∏–∫–µ—Ç** (—Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π –Ω–µ –Ω—É–∂–Ω–æ). –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —Å–Ω–æ–≤–∞ –∏ –æ—Ç–∫—Ä–æ–µ—Ç –µ–≥–æ, –µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç.';

              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner,
                repo,
                body: commentBody
              });
            }
            // --- –°–¶–ï–ù–ê–†–ò–ô 2: –í–ï–†–°–ò–Ø –ê–ö–¢–£–ê–õ–¨–ù–ê ---
            else {
              // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–∏–∫–µ—Ç, –µ—Å–ª–∏ –æ–Ω –∑–∞–∫—Ä—ã—Ç
              if (issue.data.state === 'closed') {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  state: 'open'
                });
              }

              let commentBody = '‚úÖ **Perfect!** The file `config.tar.gz` has been found, is accessible, and contains the required structure.\n\n';
              commentBody += '‚úÖ **–û—Ç–ª–∏—á–Ω–æ!** –§–∞–π–ª `config.tar.gz` –Ω–∞–π–¥–µ–Ω, –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –∏–º–µ–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É.\n\n';
              commentBody += `**Version Check / –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏:** ${versionMessage}\n\n`;
              commentBody += 'The issue has been (re)opened and will be processed. / –¢–∏–∫–µ—Ç –±—ã–ª (–ø–µ—Ä–µ)–æ—Ç–∫—Ä—ã—Ç –∏ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω.';

              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner,
                repo,
                body: commentBody
              });
            }

      # –®–ê–ì 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –û–®–ò–ë–û–ö (–Ω–µ—Ç —Ñ–∞–π–ª–∞, –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞, –∞—Ä—Ö–∏–≤ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π)
      - name: Handle missing, inaccessible, or invalid attachment
        if: steps.check_attachment.outputs.attachment_found != 'true' || steps.check_attachment.outputs.file_accessible != 'true' || (steps.verify_archive.outputs.file_valid != 'true' && steps.verify_archive.outputs.file_valid != '')
        uses: actions/github-script@v6
        env:
          ATTACHMENT_FOUND: ${{ steps.check_attachment.outputs.attachment_found }}
          FILE_ACCESSIBLE: ${{ steps.check_attachment.outputs.file_accessible }}
          VERIFICATION_ERROR: ${{ steps.verify_archive.outputs.verification_error }}
        with:
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const issue = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber
            });

            let commentBody = '';
            const attachmentFound = process.env.ATTACHMENT_FOUND === 'true';
            const fileAccessible = process.env.FILE_ACCESSIBLE === 'true';
            const verificationError = process.env.VERIFICATION_ERROR || 'Unknown archive error.';

            if (issue.data.state === 'open') {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issueNumber,
                state: 'closed'
              });
            }

            if (!attachmentFound) {
              commentBody = '‚ùå **Error!** The file `config.tar.gz` was not found in the issue.\n\n‚ùå **–û—à–∏–±–∫–∞!** –§–∞–π–ª `config.tar.gz` –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∏–∫–µ—Ç–µ.\n\n';
            } else if (!fileAccessible) {
              commentBody = '‚ö†Ô∏è **Warning!** The file `config.tar.gz` was found in the issue but is not accessible for download.\n\n‚ö†Ô∏è **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!** –§–∞–π–ª `config.tar.gz` –Ω–∞–π–¥–µ–Ω –≤ —Ç–∏–∫–µ—Ç–µ, –Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.\n\n';
            } else {
              commentBody = `üîç **Archive Content Issue!** The file \`config.tar.gz\` was found and downloaded, but it does not meet the requirements.\n\n`;
              commentBody += `**Details:** ${verificationError}\n\n`;
              commentBody += `üîç **–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –∞—Ä—Ö–∏–≤–∞!** –§–∞–π–ª \`config.tar.gz\` –Ω–∞–π–¥–µ–Ω –∏ —Å–∫–∞—á–∞–Ω, –Ω–æ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.\n\n`;
              commentBody += `**–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏:** ${verificationError}\n\n`;
            }

            commentBody += 'üîß **You can fix this by:**\n1. Click "Edit" on your original issue comment\n2. Ensure you attach a **correct** `config.tar.gz` file (it must contain `opt/config/mod_data/log/console.log` and a valid version file)\n3. Save the changes\n\n';
            commentBody += 'üîß **–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ:**\n1. –ù–∞–∂–º–∏—Ç–µ "Edit" (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å) –Ω–∞ –≤–∞—à–µ–º –∏—Å—Ö–æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏\n2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç–µ **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π** —Ñ–∞–π–ª `config.tar.gz` (–æ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å `opt/config/mod_data/log/console.log` –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–∞–π–ª –≤–µ—Ä—Å–∏–∏)\n3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è\n\n';
            commentBody += 'üîÑ After editing, this check will run again automatically.\nüîÑ –ü–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–æ–≤–∞.';

            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner,
              repo,
              body: commentBody
            });

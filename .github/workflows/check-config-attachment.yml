name: Check Config Attachment

on:
  issues:
    types: [opened, edited, reopened]

jobs:
  check-config-attachment:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      
    steps:
      - name: Check attachment status
        id: check_attachment
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            const issue = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber
            });
            
            let attachmentFound = false;
            let fileAccessible = false;
            let fileUrl = '';
            
            const markdownRegex = /\[config\.tar\.gz\]\((https?:\/\/[^\s)]+)\)/i;
            const match = issue.data.body.match(markdownRegex);
            
            if (match && match[1]) {
              attachmentFound = true;
              fileUrl = match[1];
              
              try {
                const response = await fetch(fileUrl, { method: 'HEAD' });
                if (response.ok) {
                  fileAccessible = true;
                }
              } catch (error) {
                fileAccessible = false;
              }
            }
            
            core.setOutput('attachment_found', attachmentFound.toString());
            core.setOutput('file_accessible', fileAccessible.toString());
            core.setOutput('file_url', fileUrl);

      - name: Handle successful attachment
        if: steps.check_attachment.outputs.attachment_found == 'true' && steps.check_attachment.outputs.file_accessible == 'true'
        uses: actions/github-script@v6
        env:
          ATTACHMENT_FOUND: ${{ steps.check_attachment.outputs.attachment_found }}
          FILE_ACCESSIBLE: ${{ steps.check_attachment.outputs.file_accessible }}
        with:
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            const issue = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber
            });
            
            if (issue.data.state === 'closed') {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issueNumber,
                state: 'open'
              });
              
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner,
                repo,
                body: '‚úÖ **Perfect!** The file `config.tar.gz` has been found and is accessible.\n\n‚úÖ **–û—Ç–ª–∏—á–Ω–æ!** –§–∞–π–ª `config.tar.gz` –Ω–∞–π–¥–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.\n\nThe issue has been reopened and will be processed. / –¢–∏–∫–µ—Ç –±—ã–ª –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç –∏ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω.'
              });
            }

      - name: Handle missing or inaccessible attachment
        if: steps.check_attachment.outputs.attachment_found != 'true' || steps.check_attachment.outputs.file_accessible != 'true'
        uses: actions/github-script@v6
        env:
          ATTACHMENT_FOUND: ${{ steps.check_attachment.outputs.attachment_found }}
          FILE_ACCESSIBLE: ${{ steps.check_attachment.outputs.file_accessible }}
        with:
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            const issue = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber
            });
            
            if (issue.data.state === 'open') {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issueNumber,
                state: 'closed'
              });
            }
            
            let commentBody = '';
            const attachmentFound = process.env.ATTACHMENT_FOUND === 'true';
            const fileAccessible = process.env.FILE_ACCESSIBLE === 'true';
            
            if (!attachmentFound) {
              commentBody = '‚ùå **Error!** The file `config.tar.gz` was not found in the issue.\n\n‚ùå **–û—à–∏–±–∫–∞!** –§–∞–π–ª `config.tar.gz` –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∏–∫–µ—Ç–µ.\n\n';
            } else if (!fileAccessible) {
              commentBody = '‚ö†Ô∏è **Warning!** The file `config.tar.gz` was found in the issue but is not accessible for download.\n\n‚ö†Ô∏è **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!** –§–∞–π–ª `config.tar.gz` –Ω–∞–π–¥–µ–Ω –≤ —Ç–∏–∫–µ—Ç–µ, –Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.\n\n';
            }
            
            commentBody += 'üîß **You can fix this by:**\n1. Click "Edit" on your original issue comment\n2. Attach the file `config.tar.gz` using the paperclip icon üìé\n3. Save the changes\n\nüîß **–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ:**\n1. –ù–∞–∂–º–∏—Ç–µ "Edit" (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å) –Ω–∞ –≤–∞—à–µ–º –∏—Å—Ö–æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏\n2. –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª `config.tar.gz` —á–µ—Ä–µ–∑ —Å–∫—Ä–µ–ø–æ—á–∫—É üìé\n3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è\n\n';
            
            commentBody += 'üîÑ After editing, the issue will be automatically reopened if the file is found and accessible.\n\nüîÑ –ü–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∏–∫–µ—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω.';
            
            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner,
              repo,
              body: commentBody
            });

name: Check Config Attachment

on:
  issues:
    types: [opened, edited, reopened]

jobs:
  check-config-attachment:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read # –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è, –µ—Å–ª–∏ –∞—Ä—Ö–∏–≤ –±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω –≤ workspace

    steps:
      # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–ª–æ–∂–µ–Ω–∏—è (–≤–∞—à –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥)
      - name: Check attachment status
        id: check_attachment
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const issue = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber
            });

            let attachmentFound = false;
            let fileAccessible = false;
            let fileUrl = '';

            const markdownRegex = /\[config\.tar\.gz\]\((https?:\/\/[^\s)]+)\)/i;
            const match = issue.data.body.match(markdownRegex);

            if (match && match[1]) {
              attachmentFound = true;
              fileUrl = match[1];

              try {
                const response = await fetch(fileUrl, { method: 'HEAD' });
                if (response.ok) {
                  fileAccessible = true;
                }
              } catch (error) {
                fileAccessible = false;
              }
            }

            core.setOutput('attachment_found', attachmentFound.toString());
            core.setOutput('file_accessible', fileAccessible.toString());
            core.setOutput('file_url', fileUrl);

      # –ù–û–í–´–ô –®–ê–ì 2: –°–∫–∞—á–∏–≤–∞–µ–º, —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä—Ö–∏–≤
      - name: Extract and verify archive contents
        id: verify_archive
        # –í—ã–ø–æ–ª–Ω—è–µ–º —ç—Ç–æ—Ç —à–∞–≥, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ
        if: steps.check_attachment.outputs.attachment_found == 'true' && steps.check_attachment.outputs.file_accessible == 'true'
        env:
          FILE_URL: ${{ steps.check_attachment.outputs.file_url }}
        run: |
          set -e # –ü—Ä–µ—Ä—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

          echo "Downloading config.tar.gz from $FILE_URL..."
          # –°–∫–∞—á–∏–≤–∞–µ–º –∞—Ä—Ö–∏–≤. –ò—Å–ø–æ–ª—å–∑—É–µ–º curl —Å –æ–ø—Ü–∏–µ–π -L –¥–ª—è —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∑–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞–º–∏.
          curl -L -s -o "/tmp/config.tar.gz" "$FILE_URL"

          if [ ! -s "/tmp/config.tar.gz" ]; then
            echo "ERROR: Downloaded file is empty or does not exist."
            echo "file_valid=false" >> $GITHUB_OUTPUT
            echo "verification_error=Archive is empty or failed to download." >> $GITHUB_OUTPUT
            exit 0 # –í—ã—Ö–æ–¥–∏–º –±–µ–∑ –æ—à–∏–±–∫–∏, —á—Ç–æ–±—ã workflow –ø—Ä–æ–¥–æ–ª–∂–∏–ª –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ –æ—Å—Ç–∞–≤–∏–ª –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
          fi

          echo "Extracting archive to verify contents..."
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏
          EXTRACT_DIR=$(mktemp -d)
          cd "$EXTRACT_DIR"

          # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å. tar -xzf –º–æ–ª—á–∏—Ç –ø—Ä–∏ —É—Å–ø–µ—Ö–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–µ.
          if ! tar -xzf /tmp/config.tar.gz 2>/dev/null; then
            echo "ERROR: Failed to extract config.tar.gz. File might be corrupted or not a valid gzip archive."
            echo "file_valid=false" >> $GITHUB_OUTPUT
            echo "verification_error=Failed to extract archive. File may be corrupted." >> $GITHUB_OUTPUT
            exit 0
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –≤–Ω—É—Ç—Ä–∏ –∞—Ä—Ö–∏–≤–∞
          TARGET_FILE="opt/config/mod_data/log/console.log"
          if [ -f "$EXTRACT_DIR/$TARGET_FILE" ]; then
            echo "SUCCESS: Required file '$TARGET_FILE' found inside the archive."
            echo "file_valid=true" >> $GITHUB_OUTPUT
            echo "verification_error=" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Required file '$TARGET_FILE' NOT found inside the archive."
            echo "file_valid=false" >> $GITHUB_OUTPUT
            echo "verification_error=The archive does not contain the required file: $TARGET_FILE" >> $GITHUB_OUTPUT
          fi

          # –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          rm -rf "$EXTRACT_DIR"
          rm -f "/tmp/config.tar.gz"

      # –®–∞–≥ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –£–°–ü–ï–®–ù–û–ì–û —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–∞—Ä—Ö–∏–≤ –Ω–∞–π–¥–µ–Ω, –¥–æ—Å—Ç—É–ø–µ–Ω –ò –ø—Ä–æ–≤–µ—Ä–µ–Ω)
      - name: Handle successful and valid attachment
        # –£—Å–ª–æ–≤–∏–µ —Å—Ç–∞–ª–æ —Å—Ç—Ä–æ–∂–µ: –Ω—É–∂–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–π –∞—Ä—Ö–∏–≤, –∏ —É—Å–ø–µ—à–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        if: steps.check_attachment.outputs.attachment_found == 'true' && steps.check_attachment.outputs.file_accessible == 'true' && steps.verify_archive.outputs.file_valid == 'true'
        uses: actions/github-script@v6
        env:
          ATTACHMENT_FOUND: ${{ steps.check_attachment.outputs.attachment_found }}
          FILE_ACCESSIBLE: ${{ steps.check_attachment.outputs.file_accessible }}
          FILE_VALID: ${{ steps.verify_archive.outputs.file_valid }}
        with:
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const issue = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber
            });

            if (issue.data.state === 'closed') {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issueNumber,
                state: 'open'
              });
            }

            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner,
              repo,
              body: '‚úÖ **Perfect!** The file `config.tar.gz` has been found, is accessible.\n\n‚úÖ **–û—Ç–ª–∏—á–Ω–æ!** –§–∞–π–ª `config.tar.gz` –Ω–∞–π–¥–µ–Ω, –¥–æ—Å—Ç—É–ø–µ–Ω.\n\nThe issue has been (re)opened and will be processed. / –¢–∏–∫–µ—Ç –±—ã–ª (–ø–µ—Ä–µ)–æ—Ç–∫—Ä—ã—Ç –∏ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω.'
            });

      # –®–∞–≥ 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –û–®–ò–ë–û–ö (–Ω–µ—Ç –≤–ª–æ–∂–µ–Ω–∏—è, –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –ò–õ–ò –∞—Ä—Ö–∏–≤ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π)
      - name: Handle missing, inaccessible, or invalid attachment
        # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –µ—Å–ª–∏ –ù–ï –≤—ã–ø–æ–ª–Ω–∏–ª–æ—Å—å —É—Å–ª–æ–≤–∏–µ —É—Å–ø–µ—Ö–∞ –∏–∑ —à–∞–≥–∞ 3.
        if: steps.check_attachment.outputs.attachment_found != 'true' || steps.check_attachment.outputs.file_accessible != 'true' || (steps.verify_archive.outputs.file_valid != 'true' && steps.verify_archive.outputs.file_valid != '')
        uses: actions/github-script@v6
        env:
          ATTACHMENT_FOUND: ${{ steps.check_attachment.outputs.attachment_found }}
          FILE_ACCESSIBLE: ${{ steps.check_attachment.outputs.file_accessible }}
          FILE_VALID: ${{ steps.verify_archive.outputs.file_valid }}
          VERIFICATION_ERROR: ${{ steps.verify_archive.outputs.verification_error }}
        with:
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const issue = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber
            });

            let commentBody = '';
            const attachmentFound = process.env.ATTACHMENT_FOUND === 'true';
            const fileAccessible = process.env.FILE_ACCESSIBLE === 'true';
            const fileValid = process.env.FILE_VALID === 'true';
            const verificationError = process.env.VERIFICATION_ERROR;

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º issue, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –µ—â–µ –æ—Ç–∫—Ä—ã—Ç–æ
            if (issue.data.state === 'open') {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issueNumber,
                state: 'closed'
              });
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            if (!attachmentFound) {
              commentBody = '‚ùå **Error!** The file `config.tar.gz` was not found in the issue.\n\n‚ùå **–û—à–∏–±–∫–∞!** –§–∞–π–ª `config.tar.gz` –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∏–∫–µ—Ç–µ.\n\n';
            } else if (!fileAccessible) {
              commentBody = '‚ö†Ô∏è **Warning!** The file `config.tar.gz` was found in the issue but is not accessible for download.\n\n‚ö†Ô∏è **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!** –§–∞–π–ª `config.tar.gz` –Ω–∞–π–¥–µ–Ω –≤ —Ç–∏–∫–µ—Ç–µ, –Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.\n\n';
            } else if (!fileValid) {
              // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∞—Ä—Ö–∏–≤–∞
              commentBody = `üîç **Archive Content Issue!** The file \`config.tar.gz\` was found and downloaded, but it does not meet the requirements.\n\n`;
              commentBody += `**Details:** ${verificationError}\n\n`;
              commentBody += `üîç **–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –∞—Ä—Ö–∏–≤–∞!** –§–∞–π–ª \`config.tar.gz\` –Ω–∞–π–¥–µ–Ω –∏ —Å–∫–∞—á–∞–Ω, –Ω–æ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.\n\n`;
              commentBody += `**–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏:** ${verificationError}\n\n`;
            }

            commentBody += 'üîß **You can fix this by:**\n1. Click "Edit" on your original issue comment\n2. Ensure you attach a **correct** `config.tar.gz`\n3. Save the changes\n\n';
            commentBody += 'üîß **–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ:**\n1. –ù–∞–∂–º–∏—Ç–µ "Edit" (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å) –Ω–∞ –≤–∞—à–µ–º –∏—Å—Ö–æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏\n2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç–µ **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π** —Ñ–∞–π–ª `config.tar.gz`\n3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è\n\n';

            commentBody += 'üîÑ After editing, this check will run again automatically.\nüîÑ –ü–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–æ–≤–∞.';

            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner,
              repo,
              body: commentBody
            });

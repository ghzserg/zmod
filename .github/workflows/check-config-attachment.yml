name: Check Config Attachment

on:
  issues:
    types: [opened, edited, reopened]

jobs:
  check-config-attachment:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      
    steps:
      - name: Check if config.tar.gz is attached
        id: check_attachment
        run: |
          echo "Issue body: ${{ github.event.issue.body }}"
          
          if echo "${{ github.event.issue.body }}" | grep -q "config\.tar\.gz"; then
            echo "attachment_found=true" >> $GITHUB_OUTPUT
            
            URL=$(echo "${{ github.event.issue.body }}" | grep -o 'https://[^"]*config\.tar\.gz[^"]*' | head -1)
            if [ -n "$URL" ]; then
              echo "attachment_url=$URL" >> $GITHUB_OUTPUT
              
              if curl --output /dev/null --silent --head --fail "$URL"; then
                echo "file_accessible=true" >> $GITHUB_OUTPUT
              else
                echo "file_accessible=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "file_accessible=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "attachment_found=false" >> $GITHUB_OUTPUT
            echo "file_accessible=false" >> $GITHUB_OUTPUT
          fi

      - name: Handle successful attachment
        if: steps.check_attachment.outputs.attachment_found == 'true' && steps.check_attachment.outputs.file_accessible == 'true'
        uses: actions/github-script@v6
        env:
          ATTACHMENT_FOUND: ${{ steps.check_attachment.outputs.attachment_found }}
          FILE_ACCESSIBLE: ${{ steps.check_attachment.outputs.file_accessible }}
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            if (issue.data.state === 'closed') {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                state: 'open'
              });
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '‚úÖ **Perfect!** The file `config.tar.gz` has been found and is accessible.\n\n‚úÖ **–û—Ç–ª–∏—á–Ω–æ!** –§–∞–π–ª `config.tar.gz` –Ω–∞–π–¥–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.\n\nThe issue has been reopened and will be processed. / –¢–∏–∫–µ—Ç –±—ã–ª –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç –∏ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω.'
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '‚úÖ **Perfect!** The file `config.tar.gz` has been found and is accessible.\n\n‚úÖ **–û—Ç–ª–∏—á–Ω–æ!** –§–∞–π–ª `config.tar.gz` –Ω–∞–π–¥–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.\n\nYour issue will be processed. / –í–∞—à —Ç–∏–∫–µ—Ç –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω.'
              });
            }

      - name: Handle missing or inaccessible attachment
        if: steps.check_attachment.outputs.attachment_found != 'true' || steps.check_attachment.outputs.file_accessible != 'true'
        uses: actions/github-script@v6
        env:
          ATTACHMENT_FOUND: ${{ steps.check_attachment.outputs.attachment_found }}
          FILE_ACCESSIBLE: ${{ steps.check_attachment.outputs.file_accessible }}
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            if (issue.data.state === 'open') {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                state: 'closed'
              });
            }
            
            let commentBody = '';
            const attachmentFound = process.env.ATTACHMENT_FOUND === 'true';
            const fileAccessible = process.env.FILE_ACCESSIBLE === 'true';
            
            if (!attachmentFound) {
              commentBody = '‚ùå **Error!** The file `config.tar.gz` was not found in the issue.\n\n‚ùå **–û—à–∏–±–∫–∞!** –§–∞–π–ª `config.tar.gz` –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∏–∫–µ—Ç–µ.\n\n';
            } else if (!fileAccessible) {
              commentBody = '‚ö†Ô∏è **Warning!** The file `config.tar.gz` was found in the issue but is not accessible for download.\n\n‚ö†Ô∏è **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!** –§–∞–π–ª `config.tar.gz` –Ω–∞–π–¥–µ–Ω –≤ —Ç–∏–∫–µ—Ç–µ, –Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.\n\n';
            }
            
            commentBody += 'üîß **You can fix this by:**\n1. Click "Edit" on your original issue comment\n2. Attach the file `config.tar.gz` using the paperclip icon üìé\n3. Save the changes\n\nüîß **–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ:**\n1. –ù–∞–∂–º–∏—Ç–µ "Edit" (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å) –Ω–∞ –≤–∞—à–µ–º –∏—Å—Ö–æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏\n2. –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª `config.tar.gz` —á–µ—Ä–µ–∑ —Å–∫—Ä–µ–ø–æ—á–∫—É üìé\n3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è\n\n';
            
            commentBody += 'üîÑ After editing, the issue will be automatically reopened if the file is found and accessible.\n\nüîÑ –ü–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∏–∫–µ—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω.';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
